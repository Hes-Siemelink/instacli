Script info: Creates a new agent to run in the Cloud Connector, based on a runtime definition

Input:
  endpoint:
    description: Digital.ai Platform API endpoint
    tag: digitalai.platform.Endpoint

---
# Log in to Platform API
Get token:
  endpoint: ${endpoint}
Http endpoint: ${output}

---
# Select Cloud Connector
Print: Getting Cloud Connectors for ${endpoint.id}

Http GET: /workload/v1/cloud_connectors/
Print as YAML: ${output}
${cloud_connectors}: ${output.cloud_connector_definitions}

If:
  empty: ${cloud_connectors}
  then:
    Exit: No cloud connectors available

Ask user:
  message: Select Cloud Connector
  type: select one
  choices: ${cloud_connectors}
  display: name
As: cloud_connector

---
# Select runtime
Print: Getting available runtimes for ${endpoint.id}

Http GET: /workload/v1/agent_runtimes/
${runtimes}: ${output.agent_runtimes}

Ask user:
  message: Select runtime to add
  type: select one
  choices: ${runtimes}
  display: name
As: runtime

---
# Agent alias
Ask user: Alias for agent (unique per Digital.ai Platform user)
As: alias

---
# Variable values
For each:
  ${variable}: ${runtime.variables}
  Ask user:
    message: ${variable.key}
    default: ${variable.value}
As: variables

---
# Register agent
Http POST:
  # Uses default Cloud Connector (backwards compatible).
  # Better to use /workload/v1/cloud_connectors/{cloud_connector_id}/agent_instances/
  path: /workload/v1/agent_instances/
  body:
    agent_id: ${runtime.id}
    alias: ${alias}
    description: Remote runner
    variables: ${variables}

---
# Display the ID of the agent that was just created
Print: Added agent ${alias} with runtime id ${runtime.id}
